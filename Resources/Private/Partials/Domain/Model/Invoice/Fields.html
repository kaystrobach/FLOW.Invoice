<html lang="de" xmlns:f="http://typo3.org/ns/TYPO3/Fluid/ViewHelpers"
      xmlns:="http://typo3.org/ns/KayStrobach/VisualSearch/ViewHelpers"
      xmlns:custom="http://typo3.org/ns/KayStrobach/Custom/ViewHelpers"
      xmlns:media="http://typo3.org/ns/Neos/Media/ViewHelpers"
      xmlns:b="http://typo3.org/ns/KayStrobach/Backend/ViewHelpers"
      xmlns:bs="http://typo3.org/ns/KayStrobach/Bootstrap/ViewHelpers"
      xmlns:cb="http://typo3.org/ns/FourViewture/KIS/CRM/Backend/ViewHelpers"
      xmlns:search="http://typo3.org/ns/KayStrobach/VisualSearch/ViewHelpers"
      xmlns:i="http://typo3.org/ns/KayStrobach/IconRegistry/ViewHelpers"
      data-namespace-typo3-fluid="true"
>

<pre>
    * @todo standard mail text
    * @todo Zahlungsbedinung vom Kunden auslesen
    * @todo Fälligkeitautomatisch erstellen und dann mit dem Rechnungsbetrag befüllen, das Fälligkeitsdatum wird mit dem Rechnungsdatum erstellt
    * kopie an ausgangsrechnungsjournal@4viewture.de
    * reply-to an?
</pre>

<f:if condition="!{objectIsNew}">
    <f:comment>Ugly Workaround for doctrine hydration problems</f:comment>
    <f:form.hidden property="changeable"/>
    <f:form.hidden property="number.prefix"/>
</f:if>


<bs:tab.tabWrapper state-key="invoice-{object -> f:format.identifier()}">
    <bs:tab.tabPane title="Allgemein">
        <div class="row">
            <div class="col">
                <f:render partial="Form/Text" arguments="{label:'Titel', property:'title', noEdit:object.notChangeable, required:1}"/>
            </div>
            <div class="col">
                <f:render partial="Form/Text"
                          arguments="{label:'Untertitel', property:'subTitle', noEdit:object.notChangeable}"/>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <f:render partial="Form/TextareaMarkdown"
                          arguments="{label:'Zahlungsbedingungen in Textform', property:'paymentTermText', noEdit:object.notChangeable}"/>
            </div>
            <div class="col">
                <f:render partial="Form/TextareaMarkdown"
                          arguments="{label:'Zusatzinformationen u.a. für Dauerrechnungen etc.', property:'additionalInformation', noEdit:object.notChangeable}"/>
            </div>
        </div>


        <f:render partial="Domain/Model/Tags/Edit" arguments="{tags:tags}" />
    </bs:tab.tabPane>
    <bs:tab.tabPane title="Auftrag">
        <f:render partial="Components/Panel" arguments="{heading:'Angebot'}" contentAs="body">
            <f:render partial="Form/Text"
                      arguments="{label:'Angebotsnummer', property:'offerNumber', noEdit:object.notChangeable}"/>
        </f:render>
        <f:render partial="Components/Panel" arguments="{heading:'Auftrag'}" contentAs="body">
            <div class="row">
                <div class="col">
                    <f:render partial="Form/Text"
                              arguments="{label:'Auftragsnummer *', property:'order.orderNumber', noEdit:object.notChangeable}"/>
                </div>
                <div class="col">
                    <f:render partial="Form/Text"
                              arguments="{label:'Projektname *', property:'order.customerReference', noEdit:object.notChangeable}"/>
                </div>
                <div class="col">
                    <f:render partial="Form/Date"
                              arguments="{label:'Beauftragungsdatum *', property:'order.commissioningDate', noEdit:object.notChangeable}"/>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-sm-6">
                    <f:render partial="Form/Date"
                              arguments="{label: 'Leistungszeitraum Von *', property:'periodOfPerformance.start', noEdit:object.notChangeable}"/>
                </div>
                <div class="col-sm-6">
                    <f:render partial="Form/Date"
                              arguments="{label: 'Leistungszeitraum Bis *', property:'periodOfPerformance.end', noEdit:object.notChangeable}"/>
                </div>
            </div>
        </f:render>
    </bs:tab.tabPane>
    <bs:tab.tabPane title="Kunde">
        <f:variable name="buttonRefresh">
            <f:if condition="{object.changeable}">
                <button class="btn btn-primary" formaction="{f:uri.action(action:'updateCustomerData', arguments:{object:object})}">
                    <f:translate>Kundendaten erneut laden</f:translate>
                </button>
            </f:if>
        </f:variable>
        <f:render partial="Form/Text" arguments="{property:'customer.deptorNumber', label:'Kundennummer', contentAfter:buttonRefresh, noEdit:0}" />

        <f:render partial="Domain/Embeddable/AddressEmbeddable" arguments="{prefix:'customer', noEdit:1}" />
    </bs:tab.tabPane>
    <bs:tab.tabPane title="Zusatztexte">
        <f:render partial="Components/Panel" arguments="{heading:'Generell'}" contentAs="body">
            <f:render partial="Form/TextareaMarkdown"
                     arguments="{label:'Zusatztext', property:'additionalText', noEdit:object.notChangeable, hint:'@todo wird aus der Registry befüllt, ggf. auch auswahl erlauben'}"/>
        </f:render>
        <f:render partial="Components/Panel" arguments="{heading:'Rechnungspositionen'}" contentAs="body">
            <f:render partial="Form/TextareaMarkdown" arguments="{label:'Vorlauftext (Zusatzttext vor der Rechnungspositionen)', property:'preText', noEdit:object.notChangeable}"/>
            <f:render partial="Form/TextareaMarkdown" arguments="{label:'Nachlauftext (Zusatzttext nach der Rechnungspositionen)', property:'postText', noEdit:object.notChangeable}"/>
        </f:render>
    </bs:tab.tabPane>
    <f:comment>
        <bs:tab.tabPane title="Verkäufer">
            <f:render partial="Domain/Embeddable/AddressEmbeddable" arguments="{prefix:'seller', noEdit:1}" />
        </bs:tab.tabPane>
    </f:comment>
    <bs:tab.tabPane title="Statusinformationen">
        <f:comment>
            <f:render partial="Form/Checkbox"
                      arguments="{label:'Rechnung ist komplett bezahlt', property:'paid', noEdit:1}"/>
        </f:comment>
        <f:render partial="Form/Textarea"
                  arguments="{label:'Versandstatus der Rechnung', property:'additionalText', noEdit:object.notChangeable, noEdit:1}"/>
    </bs:tab.tabPane>
</bs:tab.tabWrapper>

<f:if condition="{object.invoiceItems}">
    <f:then>
        <f:render partial="Domain/Model/InvoiceItem/Table" arguments="{_all}"/>
    </f:then>
    <f:else>
        <div class="alert alert-info mt-3">
            <f:if condition="!{object.notChangeable}">
                <f:if condition="!{objectIsNew}">
                    <f:then>
                        <f:form.button class="btn btn-success btn-xs pull-right"
                                       formaction="{f:uri.action(action: 'addInvoiceItem')}">
                            <i:icon name="add"/>
                            Rechnungsposition hinzufügen
                        </f:form.button>
                    </f:then>
                    <f:else>
                        <f:form.button class="btn btn-success btn-xs pull-right"
                                       formaction="{f:uri.action(action: 'addInvoiceItem')}" disabled="disabled"
                                       title="Erst speichern">
                            <i:icon name="add"/>
                            Rechnungsposition hinzufügen
                        </f:form.button>
                    </f:else>
                </f:if>
            </f:if>
        </div>
    </f:else>
</f:if>

<f:if condition="{object.settlementDates}">
    <f:then>
        <f:render partial="Domain/Model/SettlementDates/Table" arguments="{_all}"/>
    </f:then>
    <f:else>
        <div class="alert alert-info mt-3">
            <f:if condition="!{object.notChangeable}">
                <f:if condition="!{objectIsNew}">
                    <f:then>
                        <f:form.button class="btn btn-success btn-xs pull-right"
                                       formaction="{f:uri.action(action: 'addSettlementDate')}">
                            <i:icon name="add"/>
                            Fälligkeitsdatum hinzufügen
                        </f:form.button>
                    </f:then>
                    <f:else>
                        <f:form.button class="btn btn-success btn-xs pull-right"
                                       formaction="{f:uri.action(action: 'addSettlementDate')}" disabled="disabled"
                                       title="Erst speichern">
                            <i:icon name="add"/>
                            Fälligkeitsdatum hinzufügen
                        </f:form.button>
                    </f:else>
                </f:if>
            </f:if>
        </div>
    </f:else>
</f:if>



